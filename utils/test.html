<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Raphael Test</title>
</head>
<body>
<div id="my-canvas" style="width:140px;padding:0px;margin:0px;"></div>
<span id="ruler" style="visibility: hidden; white-space: nowrap; font-size: 10px; "></span>
<!--some html doms-->
<!--some scripts-->
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/raphael/2.2.7/raphael.min.js"></script>
<script type="text/javascript">

  String.prototype.visualLength = function() {
    var ruler = $("#ruler");
    ruler.text(this);
    return ruler[0].offsetWidth;
  } ;



  var mindmap = function(id, width, height, data) {
    var leftY = 0;
    //左侧初始高度（系统自动计算）
    var rightY = 0;
    //右侧初始高度    （系统自动计算）
    var unitWidth = 50;
    //每个文本的宽度(手工改)
    var unitHeight = 16;
    //每个文本的高度(手工改)
    var xAdd = 230;
    //x坐标偏移量(手工改)默认中心位置在(0,0),只能显示1/4图片，就是x,-y象限，需要把图片往右下方移动才能看到全貌
    var yAdd = 00;
    //y坐标偏移量(手工改)
    var xRate = 70;
    //x比例系数(手工改)用于放大内容
    var yRate = 50;
    //y比例系数(手工改)
    var lineColor = ["yellow", "FF00AC", "green", "red", "F3B1A0"];
    //线条颜色
    var colorIndex = 0;
    //对象1继承对象2的内容
    var extend = function(destination, source) {
      for (var property in source)
        destination[property] = source[property];
      return destination;
    };

    //计算孩子节点的数量
    //children是孩子部分
    //size是内部数量
    //isRight=true表示在右边
    //level表示第几层级
    //thick表示深度
    var countChildrenSize = function(data, level, isRight, depth) {
      var size = 0;
      //有几个孩子
      var leftSize = 0;
      //左侧总高度
      var rightSize = 0;
      //右侧总高度
      var thick = 0;
      //深度
      var leftThick = 0;
      //左侧总高度
      var rightThick = 0;
      //右侧总高度

      if (data["children"] != null && data["children"].length > 0) {//如果没有孩子节点，则自己设为0，返回0
        for (var i = 0; i < data["children"].length; i++) {
          var right = isRight != null ? isRight : (i % 2 == 0);
          var count = countChildrenSize(data["children"][i], level + 1, right, depth + 1);
          size += count.size;

          if (thick < count.thick) {
            thick = count.thick;
          };

          if (right) {
            rightSize += count.size;
            if (rightThick < thick) {
              rightThick = thick;
            };
          } else {
            leftSize += count.size;
            if (leftThick < thick) {
              leftThick = thick;
            };
          }
        }
        thick++;
      } else {
        size = 1;
        thick = 1;
      }
      extend(data, {
        depth : depth,
        size : size,
        level : level,
        thick : thick
      });
      if (isRight != null) {
        data.isRight = isRight;
      };
      return {
        size : size,
        thick : thick,
        rightSize : rightSize,
        leftSize : leftSize,
        rightThick : rightThick,
        leftThick : leftThick,
      };
    };

    //计算位置,json，左边深度，右边深度
    var countPos = function(data, rightThick, leftThick) {
      var width;
      var height;
      if (data["children"] != null && data["children"].length > 0) {
        var sumHeight = 0;
        for (var i = 0; i < data["children"].length; i++) {
          var pos = countPos(data["children"][i], rightThick, leftThick);
          sumHeight += pos.height;
        }
        height = sumHeight / data["children"].length;
      } else {
        if (data.isRight) {
          rightY = rightY + 1;
          height = rightY;
        } else {
          leftY = leftY + 1;
          height = leftY;
        }
      }
      if (data.isRight == null) {
        width = 0;
      } else if (data.isRight) {
        width = data.depth;
      } else {
        width = -data.depth;
      }
      ;
      var pos = {
        width : width,
        height : height
      };
      extend(data, pos);
      return pos;
    };
    //数据，绘图，父节点
    var draw = function(data, paper, parentData) {



      if (parentData != null) {//线条颜色
        data.color = parentData.color == null ? lineColor[colorIndex++] : parentData.color;
      }

      if (data["children"] != null && data["children"].length > 0) {
        for (var i = 0; i < data["children"].length; i++) {
          draw(data["children"][i], paper, data);
        }
      }
      var posX = xAdd + xRate * data.width;
      var posY = yAdd + yRate * data.height;


      //和上级的连接曲线
      if (parentData != null) {

        var _posX = xAdd + xRate * parentData.width;//父节点的x
        var _posY = yAdd + yRate * parentData.height;//父节点的y

        var start = data.isRight ? {
          x : posX,
          y : posY + unitHeight / 2
        } : {
          x : posX + unitWidth,
          y : posY + unitHeight / 2
        };//起始点
        var end = data.isRight ? {
          x : _posX + unitWidth,
          y : _posY + unitHeight / 2
        } : {
          x : _posX,
          y : _posY + unitHeight / 2
        };//结束点

        var cut1 = {
          x : end.x,
          y : start.y
        };
        var cut2 = {
          x : start.x,
          y : end.y
        };

        //曲线连接
        paper.path("M" + start.x + " " + start.y + " C" + cut1.x + " " + cut1.y + " " + cut2.x + " " + cut2.y + " " + end.x + " " + end.y).attr('stroke', data.color);
        //直线连接
        //paper.path("M"+(posX+unitWidth)+" "+(posY+unitHeight/2)+"L"+(_posX)+" "+(_posY+unitHeight/2)).attr("stroke",data.color);
        //下划线
        paper.path("M" + posX + " " + (posY + unitHeight / 2) + "L" + (posX + unitWidth) + " " + (posY + unitHeight / 2)).attr("stroke", data.color);
      }else{//第一个主题，加框
        paper.rect(posX,posY- unitHeight / 2,unitWidth,unitHeight,2);

      };
      //paper.rect((xAdd + xRate * data.width),( yAdd + yRate * data.height),(xAdd + xRate * data.width+unitHeight),( yAdd + yRate * data.height+unitHeight),10).attr("fill","yellow");

      var len = data.name.visualLength();
      //主体文本
      var text = paper.text(xAdd + xRate * data.width+(unitWidth-len)/2, yAdd + yRate * data.height, data.name);
      text.attr({
        "fill" : "dodgerblue",
        "font-size" : "10px",
        "text-anchor" : "start",
      });
      text.click(function() {
        alert(data.name);
        window.open('http://www.baidu.com');//可以用作导航，打开页面
      });

    };
    //初始化图形
    var init = function(data) {
      var paper = Raphael(id, width, height);
      //计算孩子辅助数据
      var count = countChildrenSize(data, 1, null, 0);
      console.info(count);
      var difference = Math.floor(Math.abs(count.rightSize - count.leftSize) / 2);
      //左右起始高度差
      if (count.rightSize > count.leftSize) {//初始化第一个位置
        leftY += difference;
      };
      //计算叶子相对位置
      countPos(data, count.rightThick, count.leftThick);

      draw(data, paper);
      console.info(JSON.stringify(data));
      var img = paper.toDataURL('image/png')
      $('body').append('< img src ="'+ img +'"/>')
    };

    //at last
    init(data);

  };

  var data = {
    name: 'F2E',
    title: 'F2E',
    description: '前端知识点',
    type: 'catalog',
    category: '',
    url: {
      site: '',
      github: ''
    },
    children: [
      {
        name: 'Language',
        title: '语言',
        description: '前端语言',
        type: 'catalog',
        category: 'language',
        url: {
          site: '',
          github: ''
        },
        children: [
          {
            name: 'HTML',
            title: 'HTML',
            description: '',
            type: 'catalog',
            category: 'language',
            url: {
              site: '',
              github: ''
            },
            children: [
              {
                name: 'HTML4',
                title: 'HTML4',
                description: '',
                type: 'catalog',
                category: 'language',
                url: {
                  site: '',
                  github: ''
                },
                children: []
              },
              {
                name: 'HTML5',
                title: 'HTML5',
                description: '',
                type: 'catalog',
                category: 'language',
                url: {
                  site: '',
                  github: ''
                },
                children: []
              }
            ]
          },
          {
            name: 'JavaScript',
            title: 'JavaScript',
            description: '',
            type: 'catalog',
            category: 'language',
            url: {
              site: '',
              github: ''
            },
            children: []
          },
          {
            name: 'TypeScript',
            title: 'TypeScript',
            description: '',
            type: 'catalog',
            category: 'language',
            url: {
              site: 'http://www.typescriptlang.org/',
              github: ''
            },
            children: []
          },
          {
            name: 'CoffeeScript',
            title: 'CoffeeScript',
            description: '',
            type: 'catalog',
            category: 'language',
            url: {
              site: 'http://coffeescript.org/',
              github: ''
            },
            children: []
          },
          {
            name: 'CSS',
            title: 'CSS',
            description: '',
            type: 'catalog',
            category: 'language',
            url: {
              site: '',
              github: ''
            },
            children: [
              {
                name: 'LESS',
                title: 'LESS',
                description: '',
                type: 'node',
                category: 'language',
                url: {
                  site: '',
                  github: ''
                },
                children: []
              },
              {
                name: 'SASS',
                title: 'SASS',
                description: '',
                type: 'node',
                category: 'language',
                url: {
                  site: '',
                  github: ''
                },
                children: []
              },
              {
                name: 'Stylus',
                title: 'Stylus',
                description: '',
                type: 'node',
                category: 'language',
                url: {
                  site: '',
                  github: ''
                },
                children: []
              }
            ]
          }
        ]
      },
      {
        name: 'browser',
        title: '浏览器',
        description: '',
        type: 'catalog',
        category: 'debug-browser',
        url: {
          site: '',
          github: ''
        },
        children: [
          {
            name: 'IE',
            title: 'IE浏览器',
            description: '',
            type: 'catalog',
            category: 'debug-browser',
            url: {
              site: 'https://support.microsoft.com/zh-cn/help/17621/internet-explorer-downloads',
              github: ''
            },
            children: []
          },
          {
            name: 'Chrome',
            title: 'Chrome浏览器',
            description: '',
            type: 'catalog',
            category: 'debug-browser',
            url: {
              site: 'https://www.google.cn/chrome/',
              github: ''
            },
            children: []
          },
          {
            name: 'Firefox',
            title: 'Firefox浏览器',
            description: '',
            type: 'catalog',
            category: 'debug-browser',
            url: {
              site: 'http://www.firefox.com.cn/',
              github: ''
            },
            children: []
          },
          {
            name: 'Safari',
            title: 'Safari浏览器',
            description: '',
            type: 'catalog',
            category: 'debug-browser',
            url: {
              site: 'https://www.apple.com/cn/safari/',
              github: ''
            },
            children: []
          }
        ]
      },
      {
        name: 'debug-tool',
        title: '调试工具',
        description: '',
        type: 'catalog',
        category: 'debug-tool',
        children: [
          {
            name: 'Fiddler',
            title: 'Fiddler',
            description: '',
            type: 'catalog',
            category: 'debug-tool',
            url: {
              site: 'https://www.telerik.com/fiddler',
              github: ''
            },
            children: []
          },
          {
            name: 'YSlow',
            title: 'YSlow',
            description: '',
            type: 'catalog',
            category: 'debug-tool',
            url: {
              site: '',
              github: ''
            },
            children: []
          },
          {
            name: 'whistle',
            title: 'whistle',
            description: '',
            type: 'catalog',
            category: 'debug-tool',
            url: {
              site: '',
              github: 'https://github.com/avwo/whistle'
            },
            children: []
          },
          {
            name: 'wireshark',
            title: 'wireshark',
            description: '',
            type: 'catalog',
            category: 'debug-tool',
            url: {
              site: 'https://www.wireshark.org/',
              github: ''
            },
            children: []
          },
          {
            name: 'weinre',
            title: 'weinre',
            description: '',
            type: 'catalog',
            category: 'debug-tool',
            url: {
              site: 'http://people.apache.org/~pmuellr/weinre/',
              github: 'https://www.npmjs.com/package/weinre'
            },
            children: []
          }
        ]
      },
      {
        name: 'IDE',
        title: '编辑器',
        description: '',
        type: 'catalog',
        category: 'develop-tool',
        children: [
          {
            name: 'VIM',
            title: 'VIM',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'https://www.vim.org/',
              github: ''
            },
            children: []
          },
          {
            name: 'Webstorm',
            title: 'Webstorm',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'http://www.jetbrains.com/webstorm/?fromMenu',
              github: ''
            },
            children: []
          },
          {
            name: 'Sublime',
            title: 'Sublime',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'https://www.sublimetext.com/',
              github: ''
            },
            children: []
          },
          {
            name: 'Notepad++',
            title: 'Notepad++',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'https://notepad-plus-plus.org/',
              github: ''
            },
            children: []
          },
          {
            name: 'EditPlus',
            title: 'EditPlus',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'https://www.editplus.com/',
              github: ''
            },
            children: []
          },
          {
            name: 'ATOM',
            title: 'ATOM',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'https://atom.io/',
              github: ''
            },
            children: []
          },
          {
            name: 'Brackets',
            title: 'Brackets',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'http://brackets.io/',
              github: ''
            },
            children: []
          },
          {
            name: 'HBuilder',
            title: 'HBuilder',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'http://www.dcloud.io/',
              github: ''
            },
            children: []
          },
          {
            name: 'Ace',
            title: 'Ace',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'https://ace.c9.io/',
              github: 'https://github.com/ajaxorg/ace'
            },
            children: []
          },
          {
            name: 'Visual Studio',
            title: 'Visual Studio',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'https://www.visualstudio.com/',
              github: ''
            },
            children: []
          },
          {
            name: 'Eclipse',
            title: 'Eclipse',
            description: '',
            type: 'node',
            category: 'develop-tool',
            url: {
              site: 'http://www.eclipse.org/',
              github: ''
            },
            children: []
          }
        ]
      }
    ]
  }
  mindmap("my-canvas", 800, 2000, data);
</script>

</body>
</html>
